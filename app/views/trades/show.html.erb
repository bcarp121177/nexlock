<% page_title = t("trades.show.title", default: "Trade Details") %>
<% Current.meta_tags.set(title: page_title) %>

<div class="space-y-8">
  <%= render PageHeaderComponent.new(title: page_title, subtitle: t("trades.show.subtitle", default: "Track progress and manage actions for this trade.")) do |header| %>
    <% header.actions do %>
      <%= link_to t("trades.show.back", default: "Back to trades"), trades_path, class: "btn-app-secondary" %>
    <% end %>
  <% end %>

  <div class="grid gap-6 md:grid-cols-[minmax(0,2fr)_minmax(0,1fr)]">
    <div class="space-y-6">
      <%= render CardComponent.new do %>
        <div class="flex flex-wrap items-center gap-3 justify-between">
          <div>
            <p class="text-sm text-app-muted"><%= t("trades.show.labels.status", default: "Status") %></p>
            <div class="mt-2 flex flex-wrap items-center gap-2">
              <%= trade_state_badge(@trade) %>
              <% if current_user == @trade.seller %>
                <span class="badge-app badge-app-info"><%= t("trades.show.roles.seller", default: "Seller") %></span>
              <% elsif current_user == @trade.buyer %>
                <span class="badge-app badge-app-info"><%= t("trades.show.roles.buyer", default: "Buyer") %></span>
              <% else %>
                <span class="badge-app badge-app-info"><%= t("trades.show.roles.viewer", default: "Viewer") %></span>
              <% end %>
            </div>
          </div>
          <div class="text-right">
            <p class="text-sm text-app-muted"><%= t("trades.show.labels.total", default: "Total amount") %></p>
            <p class="mt-1 text-2xl font-semibold text-app-strong"><%= trade_price(@trade) %></p>
          </div>
        </div>
      <% end %>

      <%= render CardComponent.new do %>
        <h2 class="text-lg font-semibold text-app-strong mb-4"><%= t("trades.form.sections.item", default: "Item Details") %></h2>
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <p class="text-xs uppercase tracking-wide text-app-muted"><%= t("trades.form.labels.item_name", default: "Item name") %></p>
            <p class="mt-1 text-app-strong font-medium"><%= @trade.item&.name || t("trades.show.missing", default: "Not provided") %></p>
          </div>
          <div>
            <p class="text-xs uppercase tracking-wide text-app-muted"><%= t("trades.form.labels.item_category", default: "Category") %></p>
            <p class="mt-1 text-app-strong font-medium"><%= @trade.item&.category&.titleize || t("trades.show.missing", default: "Not provided") %></p>
          </div>
          <div>
            <p class="text-xs uppercase tracking-wide text-app-muted"><%= t("trades.form.labels.item_condition", default: "Condition") %></p>
            <p class="mt-1 text-app-strong font-medium"><%= @trade.item&.condition&.titleize || t("trades.show.missing", default: "Not provided") %></p>
          </div>
          <div class="md:col-span-2">
            <p class="text-xs uppercase tracking-wide text-app-muted"><%= t("trades.form.labels.item_description", default: "Description") %></p>
            <p class="mt-1 text-app-body whitespace-pre-line"><%= @trade.item&.description || t("trades.show.missing", default: "Not provided") %></p>
          </div>
        </div>
      <% end %>

      <%= render CardComponent.new do %>
        <h2 class="text-lg font-semibold text-app-strong mb-4"><%= t("trades.show.sections.trade", default: "Trade Information") %></h2>
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <p class="text-xs uppercase tracking-wide text-app-muted"><%= t("trades.show.labels.buyer", default: "Buyer") %></p>
            <p class="mt-1 text-app-strong font-medium"><%= @trade.buyer&.name || @trade.buyer_email %></p>
          </div>
          <div>
            <p class="text-xs uppercase tracking-wide text-app-muted"><%= t("trades.show.labels.seller", default: "Seller") %></p>
            <p class="mt-1 text-app-strong font-medium"><%= @trade.seller.name %></p>
          </div>
          <div>
            <p class="text-xs uppercase tracking-wide text-app-muted"><%= t("trades.form.labels.inspection", default: "Inspection window") %></p>
            <p class="mt-1 text-app-strong font-medium"><%= t("trades.form.options.hours", default: "%{hours} hours", hours: @trade.inspection_window_hours) %></p>
          </div>
          <div>
            <p class="text-xs uppercase tracking-wide text-app-muted"><%= t("trades.show.labels.fee_split", default: "Platform fee") %></p>
            <p class="mt-1 text-app-strong font-medium">
              <%= number_to_currency(@trade.platform_fee_cents.to_f / 100) %>
              <span class="text-xs text-app-muted">(<%= @trade.fee_split.titleize %>)</span>
            </p>
          </div>
          <div>
            <p class="text-xs uppercase tracking-wide text-app-muted"><%= t("trades.show.labels.created", default: "Created") %></p>
            <p class="mt-1 text-app-strong font-medium"><%= l(@trade.created_at, format: :long) %></p>
          </div>
          <% if @trade.signed_agreement.attached? %>
            <div>
              <p class="text-xs uppercase tracking-wide text-app-muted"><%= t("trades.show.labels.agreement", default: "Signed agreement") %></p>
              <%= link_to t("trades.show.actions.view_agreement", default: "View PDF"), @trade.signed_agreement_url, target: "_blank", rel: "noopener", class: "mt-1 inline-flex text-sm text-app-accent hover:underline" %>
            </div>
          <% end %>
        </div>
      <% end %>

      <% if @trade.shipments.any? %>
        <%= render CardComponent.new do %>
          <h2 class="text-lg font-semibold text-app-strong mb-4"><%= t("trades.show.sections.shipments", default: "Shipments") %></h2>
          <div class="space-y-6">
            <% @trade.shipments.each do |shipment| %>
              <div class="border border-app-subtle rounded-lg p-4">
                <div class="flex flex-wrap items-center justify-between gap-2">
                  <span class="badge-app badge-app-info"><%= shipment.direction == "forward" ? t("trades.show.shipment.forward", default: "Forward") : t("trades.show.shipment.return", default: "Return") %></span>
                  <% if shipment.status.present? %>
                    <span class="badge-app badge-app-success"><%= shipment.status.titleize %></span>
                  <% end %>
                </div>
                <dl class="mt-3 grid gap-3 md:grid-cols-2 text-sm">
                  <div>
                    <dt class="text-app-muted"><%= t("trades.show.shipment.carrier", default: "Carrier") %></dt>
                    <dd class="text-app-strong"><%= shipment.carrier.presence || t("trades.show.missing") %></dd>
                  </div>
                  <div>
                    <dt class="text-app-muted"><%= t("trades.show.shipment.tracking", default: "Tracking number") %></dt>
                    <dd class="text-app-strong">
                      <code class="rounded bg-app-muted px-2 py-1"><%= shipment.tracking_number.presence || t("trades.show.missing") %></code>
                      <% if shipment.tracking_url.present? %>
                        <%= link_to t("trades.show.actions.track", default: "Track"), shipment.tracking_url, target: "_blank", rel: "noopener", class: "ml-2 text-xs text-app-accent hover:underline" %>
                      <% end %>
                    </dd>
                  </div>
                  <% if shipment.label_url.present? %>
                    <div>
                      <dt class="text-app-muted"><%= t("trades.show.shipment.label", default: "Label") %></dt>
                      <dd><%= link_to t("trades.show.actions.download_label", default: "Download"), shipment.label_url, target: "_blank", rel: "noopener", class: "text-app-accent hover:underline" %></dd>
                    </div>
                  <% end %>
                  <% if shipment.delivered_at.present? %>
                    <div>
                      <dt class="text-app-muted"><%= t("trades.show.shipment.delivered", default: "Delivered") %></dt>
                      <dd class="text-app-strong"><%= l(shipment.delivered_at, format: :long) %></dd>
                    </div>
                  <% end %>
                </dl>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>

      <%= render CardComponent.new do %>
        <h2 class="text-lg font-semibold text-app-strong mb-4"><%= t("trades.show.sections.media", default: "Photos & Videos") %></h2>

        <% if @trade.media.attached? %>
          <div class="space-y-6">
            <% if @image_attachments.any? %>
              <div class="grid gap-4 md:grid-cols-3">
                <% @image_attachments.each do |attachment| %>
                  <div class="relative overflow-hidden rounded-lg border border-app-subtle">
                    <% if attachment.variable? %>
                      <%= image_tag attachment.variant(resize_to_limit: [800, 800]).processed, class: "w-full h-48 object-cover" %>
                    <% else %>
                      <%= image_tag attachment, class: "w-full h-48 object-cover" %>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>

            <% if @video_attachments.any? %>
              <div class="space-y-4">
                <% @video_attachments.each do |attachment| %>
                  <div class="overflow-hidden rounded-lg border border-app-subtle">
                    <video controls class="w-full">
                      <source src="<%= url_for(attachment) %>" type="<%= attachment.blob.content_type %>">
                    </video>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-sm text-app-muted"><%= t("trades.show.media.none", default: "No media uploaded yet.") %></p>
        <% end %>

        <hr class="my-4 border-app-subtle">

        <%= form_with model: @trade, url: attach_media_trade_path(@trade), method: :post, local: true, multipart: true do |media_form| %>
          <div class="flex flex-wrap items-center gap-3">
            <div>
              <%= media_form.file_field :media_files, multiple: true, direct_upload: true, accept: "image/*,video/*", class: "block w-full text-sm text-app-body" %>
            </div>
            <button type="submit" class="btn-app-secondary"><%= t("trades.show.actions.upload_media", default: "Upload") %></button>
          </div>
          <p class="mt-2 text-xs text-app-muted"><%= t("trades.show.media.hint", default: "Upload images or short videos to document the item.") %></p>
        <% end %>
      <% end %>
    </div>

    <div class="space-y-6">
      <%= render CardComponent.new do %>
        <h3 class="text-base font-semibold text-app-strong mb-3"><%= t("trades.show.sections.summary", default: "Summary") %></h3>
        <dl class="space-y-3 text-sm">
          <div>
            <dt class="text-app-muted"><%= t("trades.show.labels.state", default: "Current state") %></dt>
            <dd class="text-app-strong"><%= @trade.formatted_state %></dd>
          </div>
          <div>
            <dt class="text-app-muted"><%= t("trades.show.labels.buyer_email", default: "Buyer email") %></dt>
            <dd class="text-app-strong"><%= @trade.buyer_email %></dd>
          </div>
          <div>
            <dt class="text-app-muted"><%= t("trades.show.labels.last_updated", default: "Last updated") %></dt>
            <dd class="text-app-strong"><%= l(@trade.updated_at, format: :long) %></dd>
          </div>
        </dl>
      <% end %>

      <%= render CardComponent.new do %>
        <h3 class="text-base font-semibold text-app-strong mb-3"><%= t("trades.show.sections.next_steps", default: "Next steps") %></h3>
        <% case @trade.state %>
        <% when "draft" %>
          <% if @is_seller %>
            <p class="text-sm text-app-muted mb-4">
              <%= t("trades.show.next_steps.ready_to_send", default: "Choose how to proceed with this trade.") %>
            </p>

            <!-- DocuSeal Signature Workflow -->
            <div class="space-y-3">
              <%= button_to "🔐 Send for Digital Signature",
                            send_for_signature_trade_path(@trade),
                            method: :post,
                            class: "btn-app-primary w-full",
                            data: { turbo_confirm: "This will send the trade for legally binding digital signatures. Continue?" } %>
              <p class="text-xs text-app-muted">Both you and the buyer will sign a legally binding agreement.</p>
            </div>

            <div class="my-4 relative">
              <div class="absolute inset-0 flex items-center">
                <div class="w-full border-t border-app-subtle"></div>
              </div>
              <div class="relative flex justify-center text-xs uppercase">
                <span class="bg-app-card px-2 text-app-muted">Or</span>
              </div>
            </div>

            <!-- Simple Agreement Workflow -->
            <div class="space-y-3">
              <% unless @invitation_sent %>
                <%= button_to t("trades.show.actions.send_to_buyer", default: "Send Simple Invitation"),
                              send_to_buyer_trade_path(@trade),
                              method: :post,
                              class: "btn-app-secondary w-full" %>
                <p class="text-xs text-app-muted">Quick workflow without legal signatures.</p>
              <% else %>
                <p class="text-sm text-app-muted">Simple invitation sent. Waiting for buyer agreement.</p>
              <% end %>
            </div>
          <% elsif @is_buyer %>
            <% if @trade.buyer_agreed_at.present? %>
              <p class="text-sm text-app-muted"><%= t("trades.show.next_steps.buyer_waiting", default: "Thanks for agreeing. Waiting for seller to proceed.") %></p>
            <% else %>
              <p class="text-sm text-app-muted mb-4"><%= t("trades.show.next_steps.buyer_invited", default: "Review the trade terms and agree to move forward.") %></p>
              <%= button_to t("trades.show.actions.agree", default: "Agree to Terms"), agree_trade_path(@trade), method: :post, class: "btn-app-primary" %>
            <% end %>
          <% else %>
            <p class="text-sm text-app-muted"><%= t("trades.show.next_steps.viewer", default: "Waiting for buyer and seller to agree to the draft.") %></p>
          <% end %>

        <% when "awaiting_seller_signature", "awaiting_buyer_signature" %>
          <% if (@is_seller && @trade.awaiting_seller_signature?) || (@is_buyer && @trade.awaiting_buyer_signature?) %>
            <p class="text-sm text-app-muted mb-4">Please review and sign the trade agreement below.</p>
            <div id="docuseal-container">
              <%= render "trades/docuseal_signature_form", trade: @trade %>
            </div>
          <% else %>
            <div class="flex items-center gap-3 p-4 bg-app-subtle rounded-lg">
              <svg class="animate-spin h-5 w-5 text-app-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <div>
                <p class="font-medium">Waiting for <%= @trade.awaiting_seller_signature? ? "seller" : "buyer" %> to sign</p>
                <p class="text-sm text-app-muted">You'll be notified when it's your turn</p>
              </div>
            </div>
          <% end %>

          <% if @is_seller %>
            <div class="mt-4 pt-4 border-t border-app-subtle">
              <%= button_to "Cancel Signature Request",
                            cancel_signature_request_trade_path(@trade),
                            method: :post,
                            class: "btn-app-secondary",
                            data: { turbo_confirm: "Cancel the signature request? The trade will return to draft." } %>
            </div>
          <% end %>

          <% if @trade.signature_deadline_at.present? %>
            <p class="mt-4 text-xs text-app-muted">
              Signature deadline: <%= l(@trade.signature_deadline_at, format: :long) %>
            </p>
          <% end %>

        <% when "signature_deadline_missed" %>
          <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
            <h4 class="font-medium text-red-900">Signature Deadline Missed</h4>
            <p class="text-sm text-red-700 mt-1">The signature request expired before both parties signed.</p>
          </div>

          <% if @is_seller %>
            <div class="mt-4">
              <%= button_to "Retry Signature Process",
                            retry_signature_trade_path(@trade),
                            method: :post,
                            class: "btn-app-primary" %>
            </div>
          <% else %>
            <p class="text-sm text-app-muted mt-4">Waiting for seller to restart the signature process.</p>
          <% end %>

        <% when "awaiting_funding" %>
          <% if @is_buyer %>
            <p class="text-sm text-app-muted mb-4">Both parties have signed the agreement. Please fund the escrow to proceed.</p>

            <% if current_user.kyc_status != "verified" %>
              <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg mb-4">
                <h4 class="font-medium text-yellow-900">KYC Verification Required</h4>
                <p class="text-sm text-yellow-700 mt-1">You need to complete identity verification before funding trades. This helps prevent fraud and protects all parties.</p>
              </div>
              <%= link_to "Complete KYC Verification",
                          edit_user_registration_path,
                          class: "btn-app-primary" %>
            <% else %>
              <%= button_to "Fund Escrow",
                            fund_trade_path(@trade),
                            method: :post,
                            class: "btn-app-primary",
                            data: {
                              turbo_confirm: "Proceed to fund #{number_to_currency(@trade.price_cents / 100.0)}?",
                              turbo: false
                            } %>
              <p class="text-xs text-app-muted mt-2">
                Amount: <%= number_to_currency(@trade.price_cents / 100.0) %>
                <% if @trade.platform_fee_cents > 0 %>
                  + <%= number_to_currency(@trade.platform_fee_cents / 100.0) %> platform fee
                <% end %>
              </p>
              <p class="text-xs text-app-muted mt-2">
                You'll be redirected to Stripe to complete payment securely.
              </p>
            <% end %>
          <% else %>
            <div class="flex items-center gap-3 p-4 bg-app-subtle rounded-lg">
              <svg class="animate-spin h-5 w-5 text-app-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <div>
                <p class="font-medium">Waiting for buyer to fund escrow</p>
                <p class="text-sm text-app-muted">You'll be notified when funding is complete</p>
              </div>
            </div>
          <% end %>

        <% when "funded" %>
          <% if @is_seller %>
            <p class="text-sm text-app-muted mb-4"><%= t("trades.show.next_steps.ship", default: "Provide tracking details once the item ships.") %></p>
            <%= form_with url: ship_trade_path(@trade), method: :post, scope: :trade, local: true do |f| %>
              <div class="space-y-3">
                <div>
                  <%= f.label :carrier, t("trades.show.shipment.carrier", default: "Carrier"), class: "block text-xs font-medium text-app-muted uppercase" %>
                  <%= f.text_field :carrier, class: "mt-1 block w-full rounded-md border border-app-subtle bg-app-card px-3 py-2 text-app-strong focus:border-app-focus focus:ring-app-focus" %>
                </div>
                <div>
                  <%= f.label :tracking_number, t("trades.show.shipment.tracking", default: "Tracking number"), class: "block text-xs font-medium text-app-muted uppercase" %>
                  <%= f.text_field :tracking_number, required: true, class: "mt-1 block w-full rounded-md border border-app-subtle bg-app-card px-3 py-2 text-app-strong focus:border-app-focus focus:ring-app-focus" %>
                </div>
                <div class="flex justify-end">
                  <%= f.submit t("trades.show.actions.ship", default: "Record Shipment"), class: "btn-app-primary" %>
                </div>
              </div>
            <% end %>
          <% else %>
            <p class="text-sm text-app-muted"><%= t("trades.show.next_steps.funded_wait", default: "Waiting for seller to ship the item.") %></p>
          <% end %>
        <% when "shipped" %>
          <% if @is_buyer %>
            <p class="text-sm text-app-muted mb-4"><%= t("trades.show.next_steps.shipped", default: "Mark the trade delivered once the package arrives.") %></p>
            <%= button_to t("trades.show.actions.mark_delivered", default: "Mark as Delivered"), mark_delivered_trade_path(@trade), method: :post, class: "btn-app-primary" %>
          <% else %>
            <p class="text-sm text-app-muted"><%= t("trades.show.next_steps.shipped_wait", default: "Item is in transit. Waiting for buyer confirmation.") %></p>
          <% end %>
        <% when "delivered_pending_confirmation" %>
          <% if @is_buyer %>
            <p class="text-sm text-app-muted mb-4"><%= t("trades.show.next_steps.delivered", default: "Confirm receipt to start the inspection window.") %></p>
            <%= button_to t("trades.show.actions.confirm_receipt", default: "Confirm Receipt"), confirm_receipt_trade_path(@trade), method: :post, class: "btn-app-primary" %>
          <% else %>
            <p class="text-sm text-app-muted"><%= t("trades.show.next_steps.delivered_wait", default: "Waiting for buyer to confirm receipt.") %></p>
          <% end %>
        <% when "inspection" %>
          <% if @is_buyer %>
            <p class="text-sm text-app-muted mb-4"><%= t("trades.show.next_steps.inspection", default: "Inspect the item and accept or reject it.") %></p>
            <div class="flex flex-wrap items-center gap-3">
              <%= button_to t("trades.show.actions.accept", default: "Accept Item"), accept_trade_path(@trade), method: :post, class: "btn-app-primary" %>
              <%= form_with url: reject_trade_path(@trade), method: :post, scope: :trade, local: true, class: "w-full space-y-3" do |f| %>
                <div>
                  <%= f.label :reason_category, t("trades.show.actions.reject_category", default: "Reason"), class: "block text-xs font-medium text-app-muted uppercase" %>
                  <%= f.select :reason_category, Trade::REJECTION_CATEGORIES.map { |cat| [cat.titleize, cat] }, {}, class: "mt-1 block w-full rounded-md border border-app-subtle bg-app-card px-3 py-2 text-app-strong focus:border-app-focus focus:ring-app-focus" %>
                </div>
                <div>
                  <%= f.label :reason_text, t("trades.show.actions.reject_reason", default: "Details"), class: "block text-xs font-medium text-app-muted uppercase" %>
                  <%= f.text_area :reason_text, rows: 3, required: true, class: "mt-1 block w-full rounded-md border border-app-subtle bg-app-card px-3 py-2 text-app-strong focus:border-app-focus focus:ring-app-focus" %>
                </div>
                <div class="flex justify-end">
                  <%= f.submit t("trades.show.actions.reject", default: "Reject Item"), class: "btn-app-secondary" %>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-sm text-app-muted"><%= t("trades.show.next_steps.inspection_wait", default: "Waiting for buyer to accept or reject the item.") %></p>
          <% end %>
        <% when "accepted" %>
          <p class="text-sm text-app-muted"><%= t("trades.show.next_steps.accepted", default: "Trade accepted. Payout is processing.") %></p>
        <% when "rejected" %>
          <% if @is_buyer %>
            <p class="text-sm text-app-muted mb-4">Item rejected. Please ship the return using the provided label.</p>
            <%= form_with url: mark_return_shipped_trade_path(@trade), method: :post, scope: :trade, local: true do |f| %>
              <div class="space-y-3">
                <div>
                  <%= f.label :carrier, "Return Carrier", class: "block text-xs font-medium text-app-muted uppercase" %>
                  <%= f.text_field :carrier, class: "mt-1 block w-full rounded-md border border-app-subtle bg-app-card px-3 py-2 text-app-strong" %>
                </div>
                <div>
                  <%= f.label :tracking_number, "Return Tracking Number", class: "block text-xs font-medium text-app-muted uppercase" %>
                  <%= f.text_field :tracking_number, required: true, class: "mt-1 block w-full rounded-md border border-app-subtle bg-app-card px-3 py-2 text-app-strong" %>
                </div>
                <div class="flex justify-end">
                  <%= f.submit "Mark Return Shipped", class: "btn-app-primary" %>
                </div>
              </div>
            <% end %>
          <% else %>
            <p class="text-sm text-app-muted">Waiting for buyer to ship return.</p>
          <% end %>

        <% when "return_in_transit" %>
          <% if @is_seller %>
            <p class="text-sm text-app-muted mb-4">Return is in transit.</p>
            <%= button_to "Mark Return Delivered", mark_return_delivered_trade_path(@trade), method: :post, class: "btn-app-primary" %>
          <% else %>
            <p class="text-sm text-app-muted">Return shipment is in transit.</p>
          <% end %>

        <% when "return_delivered_pending_confirmation" %>
          <% if @is_seller %>
            <p class="text-sm text-app-muted mb-4">Return has been delivered. Please confirm receipt.</p>
            <%= button_to "Confirm Return Receipt", confirm_return_receipt_trade_path(@trade), method: :post, class: "btn-app-primary" %>
          <% else %>
            <p class="text-sm text-app-muted">Waiting for seller to confirm return receipt.</p>
          <% end %>

        <% when "return_inspection" %>
          <% if @is_seller %>
            <p class="text-sm text-app-muted mb-4">Inspect the returned item.</p>
            <div class="flex gap-2">
              <%= button_to "Accept Return", accept_return_trade_path(@trade), method: :post, class: "btn-app-primary", data: { turbo_confirm: "Accept the return and issue refund?" } %>
              <%= button_to "Reject Return", reject_return_trade_path(@trade), method: :post, class: "btn-app-secondary", data: { turbo_confirm: "Reject the return and open a dispute?" } %>
            </div>
          <% else %>
            <p class="text-sm text-app-muted">Seller is inspecting the return.</p>
          <% end %>
        <% when "released", "refunded", "resolved_release", "resolved_refund", "resolved_split" %>
          <p class="text-sm text-app-muted"><%= t("trades.show.next_steps.completed", default: "Trade completed.") %></p>
        <% else %>
          <p class="text-sm text-app-muted"><%= t("trades.show.next_steps.progress", default: "Additional workflow actions will appear here as they are implemented.") %></p>
        <% end %>
      <% end %>
    </div>
  </div>
</div>

<% page_title = "Support Requests" %>
<% Current.meta_tags.set(title: page_title) %>

<div class="space-y-8">
  <%= render PageHeaderComponent.new(title: page_title, subtitle: "View and manage your support requests") do |header| %>
    <% header.actions do %>
      <%= link_to "New Support Request", new_support_request_path, class: "btn-app-primary" %>
    <% end %>
  <% end %>

  <div class="grid gap-4 md:grid-cols-3">
    <%= render CardComponent.new do %>
      <p class="text-sm text-app-muted">Open</p>
      <p class="mt-2 text-3xl font-semibold text-app-strong"><%= @support_requests.count { |r| r.open_status? } %></p>
    <% end %>

    <%= render CardComponent.new do %>
      <p class="text-sm text-app-muted">Responded</p>
      <p class="mt-2 text-3xl font-semibold text-app-success"><%= @support_requests.count { |r| r.responded_status? } %></p>
    <% end %>

    <%= render CardComponent.new do %>
      <p class="text-sm text-app-muted">Closed</p>
      <p class="mt-2 text-3xl font-semibold text-app-muted"><%= @support_requests.count { |r| r.closed_status? } %></p>
    <% end %>
  </div>

  <%= render CardComponent.new(class_name: "app-card-flush") do %>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-[color:var(--app-border-subtle)] text-left">
        <thead class="bg-app-muted text-sm text-app-muted uppercase tracking-wide">
          <tr>
            <th scope="col" class="px-6 py-3 font-medium">Subject</th>
            <th scope="col" class="px-6 py-3 font-medium">Status</th>
            <th scope="col" class="px-6 py-3 font-medium">Related Trade</th>
            <th scope="col" class="px-6 py-3 font-medium">Last Updated</th>
            <th scope="col" class="px-6 py-3 font-medium"><span class="sr-only">Actions</span></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-[color:var(--app-border-subtle)] text-sm">
          <% if @support_requests.any? %>
            <% @support_requests.each do |request| %>
              <tr class="transition hover:bg-[color:var(--app-surface-muted)]">
                <td class="px-6 py-4">
                  <p class="font-medium text-app-strong"><%= request.subject %></p>
                  <p class="text-xs text-app-muted">
                    <%= request.support_messages.count %> message<%= "s" unless request.support_messages.count == 1 %>
                  </p>
                </td>
                <td class="px-6 py-4">
                  <% if request.open_status? %>
                    <span class="inline-flex px-2 py-1 text-xs font-medium rounded bg-blue-100 text-blue-800">Open</span>
                  <% elsif request.responded_status? %>
                    <span class="inline-flex px-2 py-1 text-xs font-medium rounded bg-green-100 text-green-800">Responded</span>
                  <% elsif request.closed_status? %>
                    <span class="inline-flex px-2 py-1 text-xs font-medium rounded bg-gray-100 text-gray-800">Closed</span>
                  <% end %>
                </td>
                <td class="px-6 py-4">
                  <% if request.trade %>
                    <%= link_to "Trade ##{request.trade_id}", trade_path(request.trade), class: "text-app-accent hover:underline" %>
                  <% else %>
                    <span class="text-app-muted">â€”</span>
                  <% end %>
                </td>
                <td class="px-6 py-4 text-app-muted">
                  <%= time_ago_in_words(request.updated_at) %> ago
                </td>
                <td class="px-6 py-4 text-right">
                  <%= link_to "View", support_request_path(request), class: "text-sm font-medium text-app-accent hover:underline" %>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="5" class="px-6 py-10 text-center text-app-muted">
                <p class="text-base font-medium">No support requests yet</p>
                <p class="mt-1 text-sm">Need help? Create a support request to get started.</p>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <% if defined?(@pagy) && @pagy.last > 1 %>
      <div class="px-6 py-4 border-t border-[color:var(--app-border-subtle)] text-center">
        <%== @pagy.series_nav %>
      </div>
    <% end %>
  <% end %>
</div>

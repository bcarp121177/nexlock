<div class="mb-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Support Request #<%= @support_request.id %></h1>
      <p class="mt-1 text-sm text-gray-600"><%= @support_request.subject %></p>
    </div>
    <div class="flex gap-2">
      <%= link_to "Back to List", madmin_support_requests_path, class: "btn btn-secondary" %>
    </div>
  </div>
</div>

<div class="grid gap-6 lg:grid-cols-3">
  <!-- Main Content -->
  <div class="lg:col-span-2 space-y-6">
    <!-- Status & Actions Card -->
    <div class="bg-white shadow rounded-lg p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-900">Status & Actions</h2>
        <% if @support_request.open_status? %>
          <span class="inline-flex px-3 py-1 text-sm font-medium rounded bg-blue-100 text-blue-800">Open</span>
        <% elsif @support_request.responded_status? %>
          <span class="inline-flex px-3 py-1 text-sm font-medium rounded bg-green-100 text-green-800">Responded</span>
        <% elsif @support_request.closed_status? %>
          <span class="inline-flex px-3 py-1 text-sm font-medium rounded bg-gray-100 text-gray-800">Closed</span>
        <% end %>
      </div>

      <div class="flex gap-2">
        <% unless @support_request.closed_status? %>
          <%= button_to "Close Request", close_madmin_support_request_path(@support_request), method: :post, class: "btn btn-secondary", data: { confirm: "Are you sure you want to close this support request?" } %>
        <% else %>
          <%= button_to "Reopen Request", reopen_madmin_support_request_path(@support_request), method: :post, class: "btn btn-secondary" %>
        <% end %>
      </div>
    </div>

    <!-- Conversation Thread -->
    <div class="bg-white shadow rounded-lg p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-6">Conversation Thread</h2>

      <!-- Messages Container -->
      <div class="space-y-6 mb-6 max-h-[600px] overflow-y-auto pr-2">
        <% @messages.each do |message| %>
          <!-- Message Row -->
          <div class="flex gap-3 <%= message.admin_message? ? 'flex-row-reverse' : '' %>">
            <!-- Avatar -->
            <div class="flex-shrink-0">
              <% if message.admin_message? %>
                <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white font-semibold">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"></path>
                  </svg>
                </div>
              <% else %>
                <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-gray-700 font-semibold text-sm">
                  <%= message.author_name.split.map(&:first).join.upcase[0..1] %>
                </div>
              <% end %>
            </div>

            <!-- Message Content -->
            <div class="flex-1 <%= message.admin_message? ? 'max-w-[85%]' : 'max-w-[85%]' %>">
              <!-- Header -->
              <div class="flex items-baseline gap-2 mb-1 <%= message.admin_message? ? 'justify-end' : '' %>">
                <span class="font-semibold text-sm <%= message.admin_message? ? 'text-indigo-900' : 'text-gray-900' %>">
                  <% if message.admin_message? %>
                    <%= message.author&.first_name || 'Support Team' %>
                    <span class="font-normal text-xs text-indigo-700">(Support)</span>
                  <% else %>
                    <%= message.author_name %>
                  <% end %>
                </span>
                <span class="text-xs text-gray-500">
                  <%= time_ago_in_words(message.created_at) %> ago
                </span>
                <% if message.sent_via == 'email' %>
                  <span class="text-xs text-gray-400" title="Sent via email">
                    <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                  </span>
                <% end %>
              </div>

              <!-- Message Bubble -->
              <div class="rounded-2xl px-4 py-3 <%= message.admin_message? ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-900' %>">
                <div class="text-sm whitespace-pre-wrap"><%= message.body %></div>

                <!-- Attachments -->
                <% if message.files.attached? %>
                  <div class="mt-3 pt-3 border-t <%= message.admin_message? ? 'border-indigo-500' : 'border-gray-200' %>">
                    <p class="text-xs font-medium mb-2 <%= message.admin_message? ? 'text-indigo-100' : 'text-gray-600' %>">
                      <%= message.files.count %> attachment<%= message.files.count > 1 ? 's' : '' %>
                    </p>
                    <div class="flex flex-wrap gap-2">
                      <% message.files.each do |file| %>
                        <%= link_to rails_blob_path(file, disposition: "attachment"), class: "inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium rounded-lg #{message.admin_message? ? 'bg-indigo-700 hover:bg-indigo-800 text-white' : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50'}", target: "_blank" do %>
                          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                          </svg>
                          <%= file.filename %> <span class="opacity-75">(<%=number_to_human_size(file.byte_size) %>)</span>
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>

              <!-- Full timestamp on hover -->
              <div class="text-xs text-gray-400 mt-1 <%= message.admin_message? ? 'text-right' : '' %>">
                <%= l(message.created_at, format: :long) %>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <% unless @support_request.closed_status? %>
        <hr class="my-6">

        <!-- Admin Reply Form -->
        <div class="bg-gray-50 rounded-lg p-4">
          <h3 class="text-sm font-semibold text-gray-900 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
            </svg>
            Reply as Support Team
          </h3>
          <%= form_with url: reply_madmin_support_request_path(@support_request), method: :post, local: true, class: "space-y-4" do |f| %>
            <%= text_area_tag :body, nil, rows: 4, required: true, placeholder: "Type your response here...", class: "block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Add attachments (optional)
              </label>
              <div class="flex items-center gap-3">
                <label for="admin-files" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 cursor-pointer">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                  </svg>
                  Choose Files
                </label>
                <span id="admin-file-count" class="text-sm text-gray-500">No files chosen</span>
              </div>
              <%= file_field_tag :files, multiple: true, id: "admin-files", class: "hidden" %>
            </div>

            <div class="flex gap-3">
              <%= submit_tag "Send Reply", class: "btn btn-primary" %>
              <button type="button" onclick="this.form.reset(); document.getElementById('admin-file-count').textContent = 'No files chosen';" class="btn btn-secondary">Clear</button>
            </div>
          <% end %>

          <script>
            document.addEventListener('DOMContentLoaded', function() {
              const fileInput = document.getElementById('admin-files');
              const fileCount = document.getElementById('admin-file-count');

              if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                  const count = e.target.files.length;
                  if (count === 0) {
                    fileCount.textContent = 'No files chosen';
                    fileCount.className = 'text-sm text-gray-500';
                  } else if (count === 1) {
                    fileCount.textContent = e.target.files[0].name;
                    fileCount.className = 'text-sm text-gray-900 font-medium';
                  } else {
                    fileCount.textContent = count + ' files selected';
                    fileCount.className = 'text-sm text-gray-900 font-medium';
                  }
                });
              }
            });
          </script>
        </div>
      <% else %>
        <div class="p-4 rounded-lg bg-gray-100 border border-gray-300 text-center">
          <p class="text-sm text-gray-700 font-medium">This support request is closed</p>
          <p class="mt-1 text-xs text-gray-600">Closed on <%= l(@support_request.closed_at, format: :long) %> by <%= @support_request.closed_by&.name || "System" %></p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="space-y-6">
    <!-- Request Details -->
    <div class="bg-white shadow rounded-lg p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Request Details</h2>
      <dl class="space-y-3 text-sm">
        <div>
          <dt class="text-gray-600">Contact</dt>
          <dd class="font-medium text-gray-900"><%= @support_request.contact_email %></dd>
        </div>

        <div>
          <dt class="text-gray-600">Submitted By</dt>
          <dd class="font-medium text-gray-900">
            <% if @support_request.opened_by %>
              <%= link_to @support_request.opened_by.name, madmin_user_path(@support_request.opened_by), class: "text-indigo-600 hover:text-indigo-800" %>
            <% else %>
              Anonymous
            <% end %>
          </dd>
        </div>

        <div>
          <dt class="text-gray-600">Account</dt>
          <dd class="font-medium text-gray-900">
            <% if @support_request.account %>
              <%= link_to @support_request.account.name, madmin_account_path(@support_request.account), class: "text-indigo-600 hover:text-indigo-800" %>
            <% else %>
              —
            <% end %>
          </dd>
        </div>

        <div>
          <dt class="text-gray-600">Related Trade</dt>
          <dd class="font-medium text-gray-900">
            <% if @support_request.trade %>
              <%= link_to "Trade ##{@support_request.trade_id}", madmin_trade_path(@support_request.trade), class: "text-indigo-600 hover:text-indigo-800" %>
            <% else %>
              —
            <% end %>
          </dd>
        </div>

        <div>
          <dt class="text-gray-600">Created</dt>
          <dd class="font-medium text-gray-900"><%= l(@support_request.created_at, format: :long) %></dd>
        </div>

        <div>
          <dt class="text-gray-600">Last Updated</dt>
          <dd class="font-medium text-gray-900"><%= l(@support_request.updated_at, format: :long) %></dd>
        </div>

        <% if @support_request.closed_at %>
          <div>
            <dt class="text-gray-600">Closed</dt>
            <dd class="font-medium text-gray-900"><%= l(@support_request.closed_at, format: :long) %></dd>
          </div>
        <% end %>
      </dl>
    </div>

    <!-- Quick Stats -->
    <div class="bg-white shadow rounded-lg p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Statistics</h2>
      <dl class="space-y-3 text-sm">
        <div>
          <dt class="text-gray-600">Total Messages</dt>
          <dd class="text-2xl font-bold text-gray-900"><%= @messages.count %></dd>
        </div>

        <div>
          <dt class="text-gray-600">User Messages</dt>
          <dd class="text-xl font-semibold text-gray-900"><%= @messages.count { |m| m.user_message? || m.anonymous_message? } %></dd>
        </div>

        <div>
          <dt class="text-gray-600">Admin Replies</dt>
          <dd class="text-xl font-semibold text-gray-900"><%= @messages.count { |m| m.admin_message? } %></dd>
        </div>
      </dl>
    </div>
  </div>
</div>
